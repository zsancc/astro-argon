---
import type { Page } from "astro";
import { Icon } from "astro-icon/components";
import { url } from "../../utils/url-utils";

interface Props {
	page: Page;
	class?: string;
	style?: string;
}

const { page, style } = Astro.props;

const HIDDEN = -1;

const className = Astro.props.class;

const ADJ_DIST = 2;
const VISIBLE = ADJ_DIST * 2 + 1;

// for test
let count = 1;
let l = page.currentPage;
let r = page.currentPage;
while (0 < l - 1 && r + 1 <= page.lastPage && count + 2 <= VISIBLE) {
	count += 2;
	l--;
	r++;
}
while (0 < l - 1 && count < VISIBLE) {
	count++;
	l--;
}
while (r + 1 <= page.lastPage && count < VISIBLE) {
	count++;
	r++;
}

let pages: number[] = [];
if (l > 1) pages.push(1);
if (l === 3) pages.push(2);
if (l > 3) pages.push(HIDDEN);
for (let i = l; i <= r; i++) pages.push(i);
if (r < page.lastPage - 2) pages.push(HIDDEN);
if (r === page.lastPage - 2) pages.push(page.lastPage - 1);
if (r < page.lastPage) pages.push(page.lastPage);

const getPageUrl = (p: number) => {
	if (p === 1) return "/";
	return `/${p}/`;
};

const arrowButtonClass =
	"btn btn-ghost btn-square h-11 min-h-11 w-11 rounded-lg border-none shadow-none transition text-[var(--primary)] bg-[var(--card-bg)] hover:bg-[var(--surface-emphasis-hover)] active:bg-[var(--surface-emphasis-active)]";
const pageButtonClass =
	"btn btn-ghost btn-square join-item h-11 min-h-11 w-11 rounded-none border-none shadow-none transition text-75 bg-[var(--card-bg)] hover:bg-[var(--surface-emphasis-hover)] active:bg-[var(--surface-emphasis-active)] active:scale-[0.85]";
---

<nav class:list={[className, "flex flex-row gap-3 justify-center"]} style={style} aria-label="Pagination">
    <a href={page.url.prev || ""} aria-label={page.url.prev ? "Previous Page" : null}
       aria-disabled={page.url.prev == undefined ? "true" : "false"}
       class:list={[arrowButtonClass,
           {"btn-disabled pointer-events-none opacity-40": page.url.prev == undefined}
       ]}
    >
        <Icon name="material-symbols:chevron-left-rounded" class="text-[1.75rem]"></Icon>
    </a>
    <div class="join rounded-lg bg-(--card-bg) text-75 font-bold overflow-hidden">
        {pages.map((p) => {
            if (p == HIDDEN)
                return <button type="button" class="btn btn-square join-item h-11 min-h-11 w-11 rounded-none border-none shadow-none pointer-events-none text-30 bg-(--card-bg)">
                    <Icon name="material-symbols:more-horiz" />
                </button>;
            if (p == page.currentPage)
                return <button type="button" aria-current="page" class="btn btn-square join-item h-11 min-h-11 w-11 rounded-none border-none shadow-none pointer-events-none bg-(--primary) flex items-center justify-center
                    font-bold text-(--color-primary-content)"
                >
                    {p}
                </button>
            return <a href={url(getPageUrl(p))} aria-label={`Page ${p}`}
                class={pageButtonClass}
            >{p}</a>
        })}
    </div>
    <a href={page.url.next || ""} aria-label={page.url.next ? "Next Page" : null}
       aria-disabled={page.url.next == undefined ? "true" : "false"}
       class:list={[arrowButtonClass,
           {"btn-disabled pointer-events-none opacity-40": page.url.next == undefined}
       ]}
    >
        <Icon name="material-symbols:chevron-right-rounded" class="text-[1.75rem]"></Icon>
    </a>
</nav>

