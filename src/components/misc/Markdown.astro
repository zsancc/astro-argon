---
import "@fontsource-variable/jetbrains-mono";
import "@fontsource-variable/jetbrains-mono/wght-italic.css";

interface Props {
	class: string;
}
const className = Astro.props.class;
---
<div
	data-pagefind-body
	class={`prose dark:prose-invert prose-base markdown-prose custom-md ${className}`}
>
	<slot />
</div>

<script>
declare global {
	interface Window {
		__markdownCopyHandlerBound?: boolean;
	}
}

if (!window.__markdownCopyHandlerBound) {
	const timeoutMap = new WeakMap<Element, number>();

	document.addEventListener("click", (e: MouseEvent) => {
		const target = e.target as Element | null;
		if (!target || !target.classList.contains("copy-btn")) {
			return;
		}

		const preEle = target.closest("pre");
		const codeEle = preEle?.querySelector("code");
		const code = Array.from(codeEle?.querySelectorAll(".code:not(summary *)") ?? [])
			.map((el) => el.textContent)
			.map((text) => (text === "\n" ? "" : text ?? ""))
			.join("\n");

		if (navigator.clipboard && code) {
			void navigator.clipboard.writeText(code);
		}

		const currentTimeout = timeoutMap.get(target);
		if (currentTimeout) {
			window.clearTimeout(currentTimeout);
		}

		target.classList.add("success");
		const newTimeout = window.setTimeout(() => {
			target.classList.remove("success");
			timeoutMap.delete(target);
		}, 1000);
		timeoutMap.set(target, newTimeout);
	});

	window.__markdownCopyHandlerBound = true;
}
</script>
