---
import "../styles/variables.styl";
import "../styles/markdown-extend.styl";
import "../styles/global.css";

import ConfigCarrier from "@components/ConfigCarrier.astro";
import katexCssUrl from "katex/dist/katex.css?url";
import { profileConfig, siteConfig } from "@/config";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { pathsEqual, url } from "../utils/url-utils";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
	hasMath?: boolean;
}

let {
	title,
	banner,
	description,
	lang,
	setOGTypeArticle,
	hasMath = false,
} = Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// Defines shared global variables consumed by layout and component styles.
const defaultColorTheme = siteConfig.themeColor.defaultTheme;
const availableColorThemes = siteConfig.themeColor.themes;
if (!banner || typeof banner !== "string" || banner.trim() === "") {
	banner = siteConfig.banner.src;
}

const enableBanner = siteConfig.banner.enable;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = `${siteConfig.title} - ${siteConfig.subtitle}`;
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset =
	bannerOffsetByPosition[siteConfig.banner.position || "center"];
---

<!DOCTYPE html>
<html lang={siteLang} class="layout-html"
	  data-overlayscrollbars-initialize
>
	<head>

		<title>{pageTitle}</title>

		<meta charset="UTF-8" />
		<meta name="description" content={description || pageTitle}>
		<meta name="author" content={profileConfig.name}>

		<meta property="og:site_name" content={siteConfig.title}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={description || pageTitle}>
		{setOGTypeArticle ? (
        <meta property="og:type" content="article" />
        ) : (
        <meta property="og:type" content="website" />
        )}

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={description || pageTitle}>

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{BANNER_HEIGHT_EXTEND, PAGE_WIDTH, defaultColorTheme, availableColorThemes}}>
			// Load daisyUI color theme from local storage and validate against configured themes.
			localStorage.removeItem('theme'); // Legacy light/dark key is no longer used.
			const storedColorTheme = localStorage.getItem('color-theme');
			const colorTheme = storedColorTheme && availableColorThemes.includes(storedColorTheme)
				? storedColorTheme
				: defaultColorTheme;
			if (storedColorTheme !== colorTheme) {
				localStorage.setItem('color-theme', colorTheme);
			}
			document.documentElement.setAttribute('data-theme', colorTheme);
			const isDarkColorTheme = /(dark|night|dracula|dim|business|black|abyss|luxury|forest|synthwave)/i.test(colorTheme);
			document.documentElement.classList.toggle('dark', isDarkColorTheme);

			// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
			let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
			offset = offset - offset % 4;
			document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
		</script>
		<style define:vars={{
			'page-width': `${PAGE_WIDTH}rem`,
		}}></style>  <!-- Defines shared CSS variables at layout scope -->

		{hasMath && <link rel="stylesheet" href={katexCssUrl} />}

		<slot name="head"></slot>

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>

	</head>
	<body class="layout-body" class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner}]}
		  data-overlayscrollbars-initialize
	>
		<ConfigCarrier></ConfigCarrier>
		<slot />

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="layout-page-height-extend"></div>
	</body>
</html>

<style is:global define:vars={{
	bannerOffset,
	'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
	'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@reference "../styles/global.css";
@layer components {
	.enable-banner.is-home #banner-wrapper {
		@apply h-(--banner-height-home) translate-y-(--banner-height-extend)
	}
	.enable-banner #banner-wrapper {
		@apply h-(--banner-height-home)
	}

	.enable-banner.is-home #banner {
		@apply h-(--banner-height-home) translate-y-0
	}
	.enable-banner #banner {
		@apply h-(--banner-height-home) translate-y-(--bannerOffset)
	}
	.enable-banner.is-home #main-grid {
		@apply translate-y-(--banner-height-extend);
	}
	.enable-banner #top-row {
		@apply h-[calc(var(--banner-height-home)-4.5rem)] transition-all duration-300
	}
	.enable-banner.is-home #sidebar-sticky {
		@apply top-[calc(1rem-var(--banner-height-extend))]
	}
	.navbar-hidden {
		@apply opacity-0 -translate-y-16
	}
}
</style>

<script>
import { setupLayoutRuntime } from "../scripts/layout-runtime";
setupLayoutRuntime();
</script>

<script>
import { setupPhotoSwipeRuntime } from "../scripts/photoswipe-runtime";
setupPhotoSwipeRuntime();
</script>
